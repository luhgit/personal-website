---
import { getCollection } from "astro:content"
import PageLayout from "@layouts/PageLayout.astro"
import TopLayout from "@layouts/TopLayout.astro"
import BottomLayout from "@layouts/BottomLayout.astro"
import SearchCollection from "@components/SearchCollection"
import { BLOG } from "@consts"

// Load all non-draft posts
const allPosts = (await getCollection("blog")).filter((p) => !p.data.draft)

// Newest first
const posts = allPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
)

// Unique, sorted tag list
const tags = [
  ...new Set(
    posts.flatMap((p) => Array.isArray(p.data.tags) ? p.data.tags : [])
  ),
].sort((a, b) => a.localeCompare(b))

// Pre-allocate height to prevent layout shift on client mount
const estimated_initial_size = 28 + posts.length * 158 + Math.max(0, posts.length - 1) * 12
---

<PageLayout title={BLOG.TITLE} description={BLOG.DESCRIPTION}>
  <TopLayout>
    <div class="animate">
      <h1 class="text-3xl font-semibold text-black dark:text-white mt-2">
        {BLOG.TITLE}
      </h1>
      {BLOG.DESCRIPTION && <div class="mt-1">{BLOG.DESCRIPTION}</div>}
    </div>
  </TopLayout>

  <BottomLayout>
    <div
      id="search-collection-wrapper"
      class="animate"
      style={{ minHeight: `${estimated_initial_size}px` }}
    >
      <SearchCollection
        client:load
        entry_name={"blog"}
        tags={tags}
        data={posts}
      />
    </div>

    <div class="mt-6 text-sm opacity-80">
      <a
        href="https://YOUR-SUBSTACK.substack.com"
        target="_blank"
        rel="noopener"
        class="underline decoration-[.5px] decoration-black/25 dark:decoration-white/50 hover:decoration-black dark:hover:decoration-white"
      >
        See all posts on Substack â†’
      </a>
    </div>
  </BottomLayout>
</PageLayout>